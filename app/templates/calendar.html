<!-- app/templates/calendar.html -->
{% extends "base.html" %}

{% block head_extra %}
    {# FullCalendar CSS v6 - Not needed as separate file for index.global.js #}

    {# Basic CSS for event colors & Modal Overlay - KEEP THESE #}
    <style>
        #calendar { max-width: 1100px; margin: 20px auto; background-color: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;}
        .fc-event { cursor: pointer; }
        .fc-event, .fc-event-dot { /* Theme colors applied via classes below */ }
        .event-task { background-color: #3498db; border-color: #2980b9; }
        .event-milestone { background-color: #f39c12; border-color: #e67e22; }
        .event-custom { background-color: #9b59b6; border-color: #8e44ad; }
        .event-done { background-color: #2ecc71 !important; border-color: #27ae60 !important; opacity: 0.7; }
        .event-overdue { border: 2px dashed #e74c3c !important; background-color: transparent !important; color: #e74c3c !important; }
        .fc-event-title-container .fc-event-title, .fc-event-time { color: white !important; }

        /* KEEP ONLY OVERLAY STYLE - Content styling moved to theme CSS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000;}

    </style>
{% endblock %}


{% block content %}
<div class="calendar-container panel-box"> {# Content panel styling applied here #}
    <h1>{{ title }}</h1>
    <div id="calendar-loading" style="display: none; text-align: center; padding: 20px;">Loading...</div>
    {% if project %}
        <p><a href="{{ url_for('main.project_detail', project_id=project.id) }}">Back to Project</a> | <a href="{{ url_for('main.project_roadmap', project_id=project.id) }}">View Roadmap</a></p>
    {% else %}
         <p><a href="{{ url_for('main.dashboard') }}">Back to Dashboard</a></p>
    {% endif %}

    <div id='calendar'></div> {# FullCalendar renders here #}
</div>

<!-- Modal for Adding Events -->
{# Apply theme panel styling via modal-content class #}
<div id="eventModal" class="modal-overlay">
    <div class="modal-content"> {# This div will be styled by the theme CSS now #}
        <h3 id="modalTitle">Add New Event</h3>
        <div id="modalError" class="modal-error"></div> {# Error message styling in theme CSS #}
        <form id="eventForm" onsubmit="return false;">
            {# <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}
            <div class="form-group">
                <label for="eventTitle">Title:</label>
                <input type="text" id="eventTitle" name="title" required class="form-control"> {# Use form-control #}
            </div>
            <div class="form-group">
                <label for="eventDescription">Description:</label>
                <textarea id="eventDescription" name="description" class="form-control"></textarea> {# Use form-control #}
            </div>
            <div class="form-group">
                <label for="eventStart">Start:</label>
                <input type="datetime-local" id="eventStart" name="start" required class="form-control"> {# Use form-control #}
            </div>
            <div class="form-group">
                <label for="eventEnd">End:</label>
                <input type="datetime-local" id="eventEnd" name="end" required class="form-control"> {# Use form-control #}
            </div>
             <div class="form-group form-check"> {# Use form-check for layout #}
                 <input type="checkbox" id="eventAllDay" name="allDay" class="form-check-input"> {# Use form-check-input #}
                 <label for="eventAllDay" class="form-check-label">All-day event</label> {# Use form-check-label #}
            </div>
            <div class="modal-actions">
                <button type="button" id="saveEventButton" class="btn btn-primary">Save Event</button> {# Use btn classes #}
                <button type="button" id="closeModalButton" class="btn btn-secondary">Cancel</button> {# Use btn classes #}
            </div>
        </form>
    </div>
</div>


{# FullCalendar JS v6 #}
<script src='{{ url_for('static', filename='vendor/fullcalendar/index.global.min.js') }}'></script>

{# JavaScript for Calendar/Modal Interaction #}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var modal = document.getElementById('eventModal');
    var modalTitle = document.getElementById('modalTitle');
    var modalError = document.getElementById('modalError');
    var eventForm = document.getElementById('eventForm');
    var saveButton = document.getElementById('saveEventButton');
    var closeButton = document.getElementById('closeModalButton');
    var eventTitle = document.getElementById('eventTitle');
    var eventDescription = document.getElementById('eventDescription');
    var eventStart = document.getElementById('eventStart');
    var eventEnd = document.getElementById('eventEnd');
    var eventAllDay = document.getElementById('eventAllDay');

    var eventsUrl = '{{ url_for("main.calendar_events", project_id=project.id if project else None) }}';
    var newEventUrl = '{{ url_for("main.create_calendar_event_api") }}';
    var currentProjectId = {{ ('%s' % project.id)|tojson if project else 'null' }}; // Option 2

    function openModal(startStr, endStr, allDay) {
        modalTitle.textContent = 'Add New Event';
        modalError.textContent = '';
        eventForm.reset();
        const formatForInput = (isoStr) => isoStr ? isoStr.substring(0, 16) : '';
        eventStart.value = formatForInput(startStr);
        if (allDay) {
             let endDate = endStr ? new Date(endStr) : null;
             let startDate = startStr ? new Date(startStr) : null;
             if (endDate && startDate && endDate.getTime() > startDate.getTime() && endDate.getUTCDate() !== startDate.getUTCDate()) { eventEnd.value = formatForInput(startStr); }
             else { eventEnd.value = formatForInput(endStr || startStr); }
             eventAllDay.checked = true;
        } else { eventEnd.value = formatForInput(endStr); eventAllDay.checked = false; }
        modal.style.display = 'flex';
        eventTitle.focus();
    }

    function closeModal() { modal.style.display = 'none'; }
    closeButton.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

    saveButton.addEventListener('click', function() {
        modalError.textContent = '';
        const title = eventTitle.value.trim();
        const description = eventDescription.value.trim();
        const start = eventStart.value; const end = eventEnd.value; const allDay = eventAllDay.checked;
        if (!title || !start || !end) { modalError.textContent = 'Title, Start, and End times are required.'; return; }
        if (!allDay && new Date(end) <= new Date(start)) { modalError.textContent = 'End time must be after start time.'; return; }

        const eventData = { title: title, description: description, start: new Date(start).toISOString(), end: new Date(end).toISOString(), allDay: allDay };
        if (currentProjectId) { eventData.project_id = currentProjectId; }
        saveButton.disabled = true; saveButton.textContent = 'Saving...';

        fetch(newEventUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData) })
        .then(response => { if (!response.ok) { return response.json().then(err => { throw new Error(err.message || `HTTP ${response.status}`); }); } return response.json(); })
        .then(data => { if (data.status === 'success') { closeModal(); calendar.refetchEvents(); } else { modalError.textContent = 'Error: ' + (data.message || 'Could not save event.'); }})
        .catch((error) => { console.error('Error saving event:', error); modalError.textContent = 'Save failed: ' + error.message; })
        .finally(() => { saveButton.disabled = false; saveButton.textContent = 'Save Event'; });
    });

    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
      events: { url: eventsUrl, failure: function() { alert('Error fetching calendar events!'); } },
      selectable: true,
      select: function(selectInfo) { openModal(selectInfo.startStr, selectInfo.endStr, selectInfo.allDay); calendar.unselect(); },
      editable: false, dayMaxEvents: true, eventTimeFormat: { hour: 'numeric', minute: '2-digit', meridiem: 'short' },
      eventClick: function(info) { if (info.event.url) { info.jsEvent.preventDefault(); window.location.href = info.event.url; } },
      loading: function(isLoading) { var loadingEl = document.getElementById('calendar-loading'); if (loadingEl) loadingEl.style.display = isLoading ? 'block' : 'none'; }
    });
    calendar.render();
  });
</script>

{% endblock %}